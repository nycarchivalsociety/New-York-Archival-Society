<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simplified Dashboard</title>
    <!-- Bootstrap 5.3 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #3498db;
        --secondary-color: #2c3e50;
        --background-color: #ecf0f1;
        --text-color: #333;
        --border-color: #ddd;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        color: var(--secondary-color);
        margin-bottom: 20px;
        text-align: center;
      }

      .table-responsive {
        overflow-x: auto;
        margin-bottom: 30px;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: #fff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      thead {
        background-color: var(--secondary-color);
        color: #fff;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      .btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-block;
        margin-right: 5px;
      }

      .btn-info {
        background-color: var(--primary-color);
        color: #fff;
      }

      .btn-edit {
        background-color: #2ecc71;
        color: #fff;
      }

      .btn-delete {
        background-color: #e74c3c;
        color: #fff;
      }

      .btn:hover {
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <header>{% include 'auth/components/sidebar.html' %}</header>
    <div class="container">
      <h1>Simplified Dashboard</h1>

      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Table rows will be dynamically added here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- View Modal -->
    <div
      class="modal fade"
      id="itemInfoModal"
      tabindex="-1"
      aria-labelledby="itemInfoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="itemInfoModalLabel">
              Item Full Information
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="itemInfoModalBody">
            <!-- Item information will be dynamically added here -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Item Modal -->
    <div
      class="modal fade"
      id="editItemModal"
      tabindex="-1"
      aria-labelledby="editItemModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editItemModalLabel">Edit Item</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editItemForm">
              <input type="hidden" id="editItemId" />
              <div class="mb-3">
                <label for="editItemName" class="form-label">Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editItemName"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editItemFee" class="form-label">Fee</label>
                <input
                  type="number"
                  class="form-control"
                  id="editItemFee"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="editItemPhoto" class="form-label"
                  >Photo Available</label
                >
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="editItemPhoto"
                />
              </div>
              <div class="mb-3">
                <label for="editItemDescription" class="form-label"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="editItemDescription"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="editItemAdopted" class="form-label">Adopted</label>
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="editItemAdopted"
                />
              </div>
              <div class="mb-3">
                <label for="editItemImgUrl" class="form-label">Image URL</label>
                <input
                  type="text"
                  class="form-control"
                  id="editItemImgUrl"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Save changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5.3 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      async function populateTable() {
        try {
          const response = await fetch("/api/items");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const items = await response.json();
          const tableBody = document.getElementById("tableBody");
          tableBody.innerHTML = ""; // Clear existing table rows
          items.forEach((item) => {
            const row = `
              <tr>
                <td>${item.name}</td>
                <td>
                  <a href="#" class="btn btn-info" onclick="viewFullInfo('${item.id}')">View Full Info</a>
                  <a href="#" class="btn btn-edit" onclick="editItem('${item.id}')">Edit</a>
                  <a href="#" class="btn btn-delete" onclick="deleteItem('${item.id}')">Delete</a>
                </td>
              </tr>
            `;
            tableBody.innerHTML += row;
          });
        } catch (error) {
          console.error("Error fetching items:", error);
        }
      }

      async function deleteItem(itemId) {
        if (confirm("Are you sure you want to delete this item?")) {
          try {
            const response = await fetch(`/api/items/${itemId}`, {
              method: "DELETE"
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log(result);
            // Refresh the table after deleting the item
            populateTable();
          } catch (error) {
            console.error("Error deleting item:", error);
          }
        }
      }

      async function viewFullInfo(itemId) {
        try {
          const response = await fetch(`/api/items/${itemId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const item = await response.json();

          const modalBody = document.getElementById("itemInfoModalBody");
          modalBody.innerHTML = `
            <div class="row">
              <div class="col-md-6">
                <img src="${item.imgurl}" alt="${
            item.name
          }" class="img-fluid mb-3">
              </div>
              <div class="col-md-6">
                <h3>${item.name}</h3>
                <p><strong>ID:</strong> ${item.id}</p>
                <p><strong>Fee:</strong> $${item.fee}</p>
                <p><strong>Photo Available:</strong> ${
                  item.photo ? "Yes" : "No"
                }</p>
                <p><strong>Adopted:</strong> ${item.adopted ? "Yes" : "No"}</p>
                <p><strong>Description:</strong> ${item.description_text}</p>
              </div>
            </div>
          `;
          const modal = new bootstrap.Modal(
            document.getElementById("itemInfoModal")
          );
          modal.show();
        } catch (error) {
          console.error("Error fetching item details:", error);
        }
      }

      async function editItem(itemId) {
        try {
          const response = await fetch(`/api/items/${itemId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const item = await response.json();

          document.getElementById("editItemId").value = item.id;
          document.getElementById("editItemName").value = item.name;
          document.getElementById("editItemFee").value = item.fee;
          document.getElementById("editItemPhoto").checked = item.photo;
          document.getElementById("editItemDescription").value =
            item.description_text;
          document.getElementById("editItemAdopted").checked = item.adopted;
          document.getElementById("editItemImgUrl").value = item.imgurl;

          const modal = new bootstrap.Modal(
            document.getElementById("editItemModal")
          );
          modal.show();
        } catch (error) {
          console.error("Error fetching item details:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", populateTable);
    </script>

    <script>
      document
        .getElementById("editItemForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const itemId = document.getElementById("editItemId").value;
          const itemData = {
            name: document.getElementById("editItemName").value,
            fee: document.getElementById("editItemFee").value,
            photo: document.getElementById("editItemPhoto").checked,
            description_text: document.getElementById("editItemDescription")
              .value,
            adopted: document.getElementById("editItemAdopted").checked,
            imgurl: document.getElementById("editItemImgUrl").value
          };

          try {
            const response = await fetch(`/api/items/${itemId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(itemData)
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log(result);

            // Close the modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("editItemModal")
            );
            modal.hide();

            // Refresh the entire page after updating the item
            window.location.reload();
          } catch (error) {
            console.error("Error updating item:", error);
          }
        });
    </script>
  </body>
</html>
