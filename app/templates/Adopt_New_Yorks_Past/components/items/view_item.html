{% extends "layout.html" %} {% block content %}
<head>
  <style>
    body {
      font-size: 16px;
      line-height: 1.5;
    }

    .container-full {
      padding: 1rem;
    }

    .product-template {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .product-image {
      width: 100%;
      max-width: 800px;
      margin-bottom: 2rem;
    }

    .product-image img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .product-details {
      width: 100%;
      max-width: 800px;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .product-price {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .product-price .old-price {
      text-decoration: line-through;
      margin-right: 1rem;
      color: #888;
    }

    p {
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    #paypal-button-container {
      margin-top: 1rem;
    }

    @media (min-width: 768px) {
      .product-template {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }

      .product-image {
        flex: 0 0 55%;
        margin-right: 2rem;
        margin-bottom: 0;
      }

      .product-details {
        flex: 0 0 40%;
      }

      h1 {
        font-size: 2.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container-full">
    <div class="product-template">
      <div class="product-image">
        {% if item.photo %}
        <img
          src="{{ item.imgurl }}"
          class="card-img-top"
          alt="{{ item.name }}"
        />
        {% else %}
        <img
          src="{{ url_for('static', filename='images/no_image.jpg') }}"
          class="card-img-top"
          alt="{{ item.name }}"
        />
        {% endif %}
      </div>
      <div class="product-details">
        <h1>{{ item.name }}</h1>
        <div class="product-price">
          <span class="new-price">${{ item.fee }}</span>
        </div>
        <p class="text-start fw-normal">{{ item.description }}</p>

        {% if not item.adopted %}
        <p>This item is <b style="color: red">available</b> for adoption</p>
        <div id="payment-status"></div>
        <div id="paypal-button-container"></div>
        {% endif %}

        <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
        <script>
          // Initialize EmailJS
          emailjs.init("jYV8y8AwgFM2SI98x");

          var item = {
            name: "{{ item.name }}",
            id: "{{ item.id }}",
            fee: "{{ item.fee }}"
          };

          var recipientEmails = ["nycarchivalsociety@gmail.com"];

          // Function to send the purchase notification
          function sendPurchaseNotification(item, recipientEmails) {
            recipientEmails.forEach(function (email) {
              var templateParams = {
                to_name: email,
                from_name: "NYAS SITE",
                subject: "Purchase made!",
                message:
                  "A purchase has been made for the item '" +
                  item.name +
                  "' (Item ID: " +
                  item.id +
                  ") by the amount of $" +
                  item.fee +
                  ". Please check the PayPal account for more details."
              };

              emailjs
                .send("service_ogwzo2j", "template_lqrxlkm", templateParams)
                .then(
                  function (response) {
                    console.log("SUCCESS!", response.status, response.text);
                  },
                  function (error) {
                    console.log("FAILED...", error);
                  }
                );
            });
          }

          // Define your item and recipient emails array as follows:
          var item = {
            name: "{{ item.name }}",
            id: "{{ item.id }}",
            fee: "{{ item.fee }}"
          };

          // Function to render PayPal buttons
          function renderPaypalButtons() {
            paypal
              .Buttons({
                createOrder: function (data, actions) {
                  return actions.order.create({
                    purchase_units: [
                      {
                        amount: {
                          value: item.fee
                        }
                      }
                    ],
                    application_context: {
                      shipping_preference: "NO_SHIPPING"
                    }
                  });
                },
                onApprove: function (data, actions) {
                  return actions.order.capture().then(function (details) {
                    document.getElementById("payment-status").innerHTML =
                      '<div class="alert alert-success">Payment successful! Thank you for your purchase.</div>';
                    // Call the function with the necessary arguments
                    sendPurchaseNotification(item, recipientEmails);
                  });
                },
                onError: function (err) {
                  document.getElementById("payment-status").innerHTML =
                    '<div class="alert alert-danger">An error occurred during the payment process. Please try again.</div>';
                  console.error("Payment error: ", err);
                }
              })
              .render("#paypal-button-container");
          }

          // Load PayPal buttons
          if (typeof paypal === "undefined") {
            const script = document.createElement("script");
            script.src =
              "https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD&disable-funding=credit";
            script.onload = renderPaypalButtons;
            document.head.appendChild(script);
          } else {
            renderPaypalButtons();
          }
        </script>

        {% if item.adopted %} {% if item.donors %}
        <p>This item <b style="color: red">has been</b> adopted by:</p>
        <ul>
          {% for donor in item.donors %}
          <li>{{ donor.donor_name }}</li>
          {% endfor %}
        </ul>
        {% endif %} {% endif %}
      </div>
    </div>
  </div>
</body>
{% endblock %}
