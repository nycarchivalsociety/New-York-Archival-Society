{% extends "layout.html" %} {% block content %}

<head>
  <title>Bond Details</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js" async></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background-color: #7e8187;
      color: white;
    }

    .container-full {
      padding: 1rem;
    }

    .product-template {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .product-image {
      width: 100%;
      max-width: 800px;
      margin-bottom: 2rem;
    }

    .product-image img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .product-details {
      width: 100%;
      max-width: 800px;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .product-price {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    p {
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    #paypal-button-container {
      margin-top: 1rem;
    }

    @media (min-width: 768px) {
      .product-template {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }

      .product-image {
        flex: 0 0 55%;
        margin-right: 2rem;
        margin-bottom: 0;
      }

      .product-details {
        flex: 0 0 40%;
      }

      h1 {
        font-size: 2.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container-full mt-5">
    <div class="product-template">
      <div class="product-image">
        <img
          src="{{ bond.front_image or url_for('static', filename='images/no_image.jpg') }}"
          alt="Bond Image A"
        />
        {% if bond.back_image %}
        <img
          src="{{ bond.back_image }}"
          alt="Bond Image B"
          style="margin-top: 1rem"
        />
        {% endif %}
      </div>
      <div class="product-details">
        <h1>Bond Number: {{ bond.bond_id }} - {{ bond.type }}</h1>
        <div class="product-price">
          Purchase Price: ${{ bond.retail_price }} + $5 Mailing Cost
        </div>
        <p><strong>Purpose of bond:</strong> {{ bond.purpose_of_bond }}</p>
        <p>
          <strong>Par Value of Canceled Vintage Bond:</strong> {{ bond.par_value
          }}
        </p>
        <p><strong>Vignette:</strong> {{ bond.vignette }}</p>
        <p><strong>Issue Date:</strong> {{ bond.issue_date }}</p>
        <p><strong>Due Date:</strong> {{ bond.due_date }}</p>
        <p><strong>Mayor:</strong> {{ bond.mayor }}</p>
        <p><strong>Comptroller:</strong> {{ bond.comptroller }}</p>
        <p><strong>Size:</strong> {{ bond.size }}</p>
        {% if bond.status == "available" %}
        <div id="payment-status"></div>
        <div id="paypal-button-container"></div>
        {% else %}
        <p class="mt-3 text-danger"><strong>This item is sold, please look for others bonds!</strong></p>
        {% endif %}
      </div>
    </div>
  </div>

  <script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD&disable-funding=credit"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Initialize EmailJS
      emailjs.init("{{ EMAILJS_API_ID }}");

      // Set recipient emails
      const recipientEmails = ["{{ RECIPIENT_EMAILS }}"];

      // Email notification function - Updated to include shipping address
      function sendPurchaseNotification(item, recipientEmails, shippingAddress, donorInfo) {
        recipientEmails.forEach((email) => {
          const templateParams = {
            to_name: email,
            from_name: "NYAS SITE",
            subject: "Bond Purchase!",
            item_name: item.name,
            item_id: item.id,
            item_fee: item.fee,
            // Include donor info
            donor_name: donorInfo.name,
            donor_email: donorInfo.email,
            // Include shipping address for delivery
            street: shippingAddress.street,
            apartment: shippingAddress.apartment,
            city: shippingAddress.city, 
            state: shippingAddress.state,
            zip_code: shippingAddress.zip_code
          };

          emailjs
            .send(
              "{{ EMAILJS_SERVICE_ID }}",
              "{{ EMAILJS_TEMPLATE_ID_FOR_PAYPAL_CONFIRMATION_EMAIL }}",
              templateParams
            )
            .then((response) => {
              console.log("Email successfully sent!", response.status, response.text);
            })
            .catch((error) => {
              console.error("Email failed to send...", error);
            });
        });
      }

      if ("{{ bond.status }}" === "available") {
        paypal
          .Buttons({
            createOrder: (data, actions) => {
              return actions.order.create({
                purchase_units: [
                  {
                    reference_id: "{{ bond.bond_id }}",
                    amount: {
                      value: "{{ bond.retail_price + 5 }}"
                    }
                  }
                ],
                application_context: {
                  shipping_preference: "GET_FROM_FILE" // Changed from SET_PROVIDED_ADDRESS
                }
              });
            },
            onApprove: (data, actions) => {
              return actions.order.capture().then((details) => {
                const payer = details.payer;
                const shipping = details.purchase_units[0].shipping;

                // Create item object for email
                const item = {
                  name: "{{ bond.type }} - {{ bond.bond_id }}",
                  id: "{{ bond.bond_id }}",
                  fee: "{{ bond.retail_price }}"
                };

                // Get shipping address from PayPal response
                const shippingAddress = {
                  street: shipping.address.address_line_1 || "N/A",
                  apartment: shipping.address.address_line_2 || "N/A",
                  city: shipping.address.admin_area_2 || "N/A",
                  state: shipping.address.admin_area_1 || "N/A",
                  zip_code: shipping.address.postal_code || "N/A"
                };

                // Create transaction object with all required data
                const transaction = {
                  paypal_transaction_id: details.id,
                  item_id: "{{ bond.bond_id }}",
                  donor_name: `${payer.name.given_name} ${payer.name.surname}`,
                  donor_email: payer.email_address,
                  fee: "{{ bond.retail_price + 5 }}",
                  payment_status: details.status,
                  shipping_address: shippingAddress
                };

                $.ajax({
                  type: "POST",
                  url: `/capture-order/${details.id}`,
                  contentType: "application/json",
                  data: JSON.stringify(transaction),
                  success: function () {
                    // Send email with complete shipping information
                    const donorInfo = {
                      name: `${payer.name.given_name} ${payer.name.surname}`,
                      email: payer.email_address
                    };
                    
                    // Send email notification with shipping address
                    sendPurchaseNotification(item, recipientEmails, shippingAddress, donorInfo);
                    
                    Swal.fire({
                      title: "Thank you for your purchase!",
                      text: "The bond has been successfully purchased.",
                      icon: "success",
                      confirmButtonText: "OK"
                    }).then(() => {
                      window.location.href = "/bonds";
                    });
                  },
                  error: function () {
                    Swal.fire({
                      title: "Transaction Error",
                      text: "An error occurred while processing your transaction. Please try again.",
                      icon: "error",
                      confirmButtonText: "OK"
                    });
                  }
                });
              });
            },
            onError: (err) => {
              Swal.fire({
                title: "Payment Error",
                text: "An error occurred during the payment process. Please try again.",
                icon: "error",
                confirmButtonText: "OK"
              });
            }
          })
          .render("#paypal-button-container");
      }
    });
  </script>
</body>

{% endblock %}
