{% extends "layout.html" %} {% block content %}

<head>
  <title>Bond Details</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js" async></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background-color: black;
      color: white;
    }

    .container-full {
      padding: 1rem;
    }

    .product-template {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .product-image {
      width: 100%;
      max-width: 800px;
      margin-bottom: 2rem;
    }

    .product-image img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .product-details {
      width: 100%;
      max-width: 800px;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .product-price {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    p {
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    #paypal-button-container {
      margin-top: 1rem;
    }

    @media (min-width: 768px) {
      .product-template {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }

      .product-image {
        flex: 0 0 55%;
        margin-right: 2rem;
        margin-bottom: 0;
      }

      .product-details {
        flex: 0 0 40%;
      }

      h1 {
        font-size: 2.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container-full mt-5">
    <div class="product-template">
      <div class="product-image">
        <img
          src="{{ bond.front_image or url_for('static', filename='images/no_image.jpg') }}"
          alt="Bond Image A"
        />
        {% if bond.back_image %}
        <img
          src="{{ bond.back_image }}"
          alt="Bond Image B"
          style="margin-top: 1rem"
        />
        {% endif %}
      </div>
      <div class="product-details">
        <h1>Bond Number: {{ bond.bond_id }} - {{ bond.type }}</h1>
        <div class="product-price">
          Purchase Price: ${{ bond.retail_price }}
          <span id="handling-text" style="display: none;">+ $5 Handling Cost</span>
          <span id="international-text" style="display: none; color: #EC994B;">+ $20 International Shipping</span>
        </div>
        <p><strong>Purpose of bond:</strong> {{ bond.purpose_of_bond }}</p>
        <p>
          <strong>Par Value of Canceled Vintage Bond:</strong> {{ bond.par_value
          }}
        </p>
        <p><strong>Vignette:</strong> {{ bond.vignette }}</p>
        <p><strong>Issue Date:</strong> {{ bond.issue_date }}</p>
        <p><strong>Due Date:</strong> {{ bond.due_date }}</p>
        <p><strong>Mayor:</strong> {{ bond.mayor }}</p>
        <p><strong>Comptroller:</strong> {{ bond.comptroller }}</p>
        <p><strong>Size:</strong> {{ bond.size }}</p>
        {% if bond.status == "available" %}
        <div id="payment-status"></div>
        <div class="form-check mb-3">
          <input
            class="form-check-input"
            type="checkbox"
            id="pickup-checkbox"
          />
          <label class="form-check-label" for="pickup-checkbox">
            In-person pickup <small style="color: #6c757d; font-style: italic;">(USA addresses only)</small>
          </label>
        </div>
        <div id="paypal-button-container"></div>
        {% else %}
        <p class="mt-3 text-danger">
          <strong>This item is sold, please look for others bonds.</strong>
        </p>
        {% endif %}
      </div>
    </div>
  </div>

  <script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD&disable-funding=credit"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Initialize EmailJS
      emailjs.init("{{ EMAILJS_API_ID }}");
      const recipientEmails = ["{{ RECIPIENT_EMAILS }}"];

      const pickupEl = document.getElementById("pickup-checkbox");
      const handlingEl = document.getElementById("handling-text");
      const intlEl = document.getElementById("international-text");

      const ITEM_PRICE = parseFloat("{{ bond.retail_price }}");
      const HANDLING_FEE = 5.00;
      const INTL_SHIPPING_FEE = 20.00;

      let lastCountry = "US"; // default assumption until onShippingChange fires

      function isPickup() {
        return !!pickupEl.checked;
      }

      function computeFees(country, pickup) {
        // For pickup: no fees
        // For USA: $5 handling fee only
        // For International: $20 international shipping fee only (includes handling)
        const handling = pickup ? 0.00 : (country === "US" ? HANDLING_FEE : 0.00);
        const shipping = pickup ? 0.00 : (country === "US" ? 0.00 : INTL_SHIPPING_FEE);
        const total = (ITEM_PRICE + handling + shipping).toFixed(2);
        return { handling, shipping, total };
      }

      function updatePricingUI({ handling, shipping, pickup, country }) {
        if (handlingEl) handlingEl.style.display = pickup ? "none" : (handling > 0 ? "inline" : "none");
        if (intlEl) intlEl.style.display = (!pickup && country !== "US" && shipping > 0) ? "inline" : "none";
      }

      // Update UI immediately if user toggles pickup before opening PayPal
      if (pickupEl) {
        pickupEl.addEventListener("change", function () {
          const fees = computeFees(lastCountry, isPickup());
          updatePricingUI({ ...fees, pickup: isPickup(), country: lastCountry });
        });
      }

      function sendPurchaseNotification(item, recipientEmails, shippingAddress, donorInfo, isPickup, breakdown) {
        recipientEmails.forEach((email) => {
          const templateParams = {
            to_name: email,
            from_name: "NYAS SITE",
            subject: "Bond Purchase!",
            item_name: item.name,
            item_id: item.id,
            item_fee: breakdown.total,
            donor_name: donorInfo.name,
            donor_email: donorInfo.email,
            donor_phone: donorInfo.phone || "Not provided",
            pickup_status: isPickup ? "IN-PERSON PICKUP" : "SHIPPING REQUIRED",
            pickup: isPickup ? "Yes - In-person pickup" : "No - Ship to address",
            street: shippingAddress.street || "N/A",
            apartment: shippingAddress.apartment || "N/A",
            city: shippingAddress.city || "N/A",
            state: shippingAddress.state || "N/A",
            zip_code: shippingAddress.zip_code || "N/A",
            // Optional: include breakdown in the email template (update template if desired)
            base_price: ITEM_PRICE.toFixed(2),
            handling_fee: breakdown.handling.toFixed(2),
            shipping_fee: breakdown.shipping.toFixed(2),
            total_paid: breakdown.total
          };

          emailjs
            .send(
              "{{ EMAILJS_SERVICE_ID }}",
              "{{ EMAILJS_TEMPLATE_ID_FOR_PAYPAL_CONFIRMATION_EMAIL }}",
              templateParams
            )
            .catch((error) => console.error("Email failed to send...", error));
        });
      }

      if ("{{ bond.status }}" === "available") {
        paypal.Buttons({
          createOrder: (data, actions) => {
            // Always request shipping address so onShippingChange can run
            const fees = computeFees("US", isPickup()); // assume US initially
            const breakdown = {
              item_total: { currency_code: "USD", value: ITEM_PRICE.toFixed(2) },
              handling: { currency_code: "USD", value: fees.handling.toFixed(2) },
              shipping: { currency_code: "USD", value: fees.shipping.toFixed(2) }
            };

            return actions.order.create({
              purchase_units: [{
                reference_id: "{{ bond.bond_id }}",
                amount: {
                  currency_code: "USD",
                  value: fees.total,
                  breakdown
                }
              }],
              application_context: {
                shipping_preference: "GET_FROM_FILE"
              }
            });
          },

          onShippingChange: function(data, actions) {
            const country = data.shipping_address.country_code || "US";
            lastCountry = country;
            const pickup = isPickup();

            // Enforce USA-only for pickup
            if (pickup && country !== "US") {
              Swal.fire({
                icon: "error",
                title: "In-person pickup restricted",
                text: "In-person pickup is only available for USA addresses. Please uncheck the pickup option or use a U.S. shipping address."
              });
              return actions.reject();
            }

            const fees = computeFees(country, pickup);

            // Patch the order with the new totals and breakdown
            const patches = [{
              op: "replace",
              path: "/purchase_units/@reference_id=='{{ bond.bond_id }}'/amount",
              value: {
                currency_code: "USD",
                value: fees.total,
                breakdown: {
                  item_total: { currency_code: "USD", value: ITEM_PRICE.toFixed(2) },
                  handling: { currency_code: "USD", value: fees.handling.toFixed(2) },
                  shipping: { currency_code: "USD", value: fees.shipping.toFixed(2) }
                }
              }
            }];

            return actions.order.patch(patches).then(function() {
              updatePricingUI({ ...fees, pickup, country });
              return actions.resolve();
            }).catch(function(err) {
              console.error("Patch error:", err);
              Swal.fire({
                icon: "error",
                title: "Unable to update total",
                text: "We could not update the total based on your address. Please try again."
              });
              return actions.reject();
            });
          },

          onApprove: (data, actions) => {
            return actions.order.capture().then((details) => {
              const payer = details.payer;
              const purchaseUnit = details.purchase_units && details.purchase_units[0];
              const shipping = purchaseUnit && purchaseUnit.shipping ? purchaseUnit.shipping : {};
              const isPickupSelected = isPickup();

              const shippingAddress = shipping.address ? {
                street: shipping.address.address_line_1 || "N/A",
                apartment: shipping.address.address_line_2 || "N/A",
                city: shipping.address.admin_area_2 || "N/A",
                state: shipping.address.admin_area_1 || "N/A",
                zip_code: shipping.address.postal_code || "N/A"
              } : {
                street: isPickupSelected ? "N/A (In-person pickup)" : "N/A",
                apartment: "N/A",
                city: "N/A",
                state: "N/A",
                zip_code: "N/A"
              };

              // Derive actual paid amounts from the captured order
              const paidAmount = purchaseUnit && purchaseUnit.amount ? parseFloat(purchaseUnit.amount.value) : (ITEM_PRICE + (isPickupSelected ? 0 : HANDLING_FEE));
              const breakdown = {
                handling: purchaseUnit?.amount?.breakdown?.handling?.value ? parseFloat(purchaseUnit.amount.breakdown.handling.value) : (isPickupSelected ? 0 : HANDLING_FEE),
                shipping: purchaseUnit?.amount?.breakdown?.shipping?.value ? parseFloat(purchaseUnit.amount.breakdown.shipping.value) : 0,
                total: paidAmount.toFixed(2)
              };

              // Prepare transaction for server-side capture logging
              const transaction = {
                paypal_transaction_id: details.id,
                item_id: "{{ bond.bond_id }}",
                donor_name: `${payer.name.given_name} ${payer.name.surname}`,
                donor_email: payer.email_address,
                donor_phone: payer.phone?.phone_number?.national_number || null,
                fee: breakdown.total, // total paid
                payment_status: details.status,
                shipping_address: shippingAddress,
                pickup: isPickupSelected
              };

              // Persist and notify
              $.ajax({
                type: "POST",
                url: `/capture-order/${details.id}`,
                contentType: "application/json",
                data: JSON.stringify(transaction),
                success: function () {
                  const donorInfo = {
                    name: `${payer.name.given_name} ${payer.name.surname}`,
                    email: payer.email_address,
                    phone: payer.phone?.phone_number?.national_number || "Not provided"
                  };

                  const item = {
                    name: "{{ bond.type }}",
                    id: "{{ bond.bond_id }}"
                  };

                  sendPurchaseNotification(item, recipientEmails, shippingAddress, donorInfo, isPickupSelected, breakdown);

                  Swal.fire({
                    icon: "success",
                    title: "Thank you!",
                    text: "Your purchase was successful."
                  }).then(() => {
                    window.location.reload();
                  });
                },
                error: function (err) {
                  console.error(err);
                  Swal.fire({
                    icon: "warning",
                    title: "Payment captured but logging failed",
                    text: "We received your payment, but had trouble saving your order. Please contact support with your PayPal Transaction ID."
                  });
                }
              });
            });
          },

          onError: (err) => {
            console.error("PayPal error:", err);
            Swal.fire({
              icon: "error",
              title: "Payment error",
              text: "There was a problem processing the payment. Please try again."
            });
          }
        }).render("#paypal-button-container");

        // Initialize the UI flags based on defaults
        const initialFees = computeFees(lastCountry, isPickup());
        updatePricingUI({ ...initialFees, pickup: isPickup(), country: lastCountry });
      }
    });
  </script>
</body>

{% endblock %}
