<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <!-- Permissions-Policy Configuration:
         - payment: Allows PayPal domains to use Payment Request API for processing transactions
         - unload: Required for PayPal to track when users leave the checkout flow (for analytics/cleanup)
         Note: The unload permission is critical for PayPal's SDK to function properly during checkout -->
    <meta http-equiv="Permissions-Policy" content="payment=(self 'https://www.paypal.com' 'https://*.paypal.com'), unload=(self 'https://www.paypal.com' 'https://*.paypal.com')" />
    <title>New York Archival Society</title>

    <!-- Critical CSS - Load immediately -->
    <link
      href="{{ url_for('static', filename='vendor/bootstrap/css/bootstrap.min.css') }}"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='css/style.css') }}"
      rel="stylesheet"
    />
    
    <!-- Non-critical CSS - Load with preload and async -->
    <link
      href="{{ url_for('static', filename='vendor/animate.css/animate.min.css') }}"
      rel="preload"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      href="{{ url_for('static', filename='vendor/aos/aos.css') }}"
      rel="preload"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      href="{{ url_for('static', filename='vendor/bootstrap-icons/bootstrap-icons.css') }}"
      rel="preload"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      href="{{ url_for('static', filename='vendor/boxicons/css/boxicons.min.css') }}"
      rel="preload"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      href="{{ url_for('static', filename='vendor/glightbox/css/glightbox.min.css') }}"
      rel="preload"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <link
      href="{{ url_for('static', filename='vendor/swiper/swiper-bundle.min.css') }}"
      rel="preload"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    
    <!-- Fallback for browsers that don't support preload -->
    <noscript>
      <link href="{{ url_for('static', filename='vendor/animate.css/animate.min.css') }}" rel="stylesheet" />
      <link href="{{ url_for('static', filename='vendor/aos/aos.css') }}" rel="stylesheet" />
      <link href="{{ url_for('static', filename='vendor/bootstrap-icons/bootstrap-icons.css') }}" rel="stylesheet" />
      <link href="{{ url_for('static', filename='vendor/boxicons/css/boxicons.min.css') }}" rel="stylesheet" />
      <link href="{{ url_for('static', filename='vendor/glightbox/css/glightbox.min.css') }}" rel="stylesheet" />
      <link href="{{ url_for('static', filename='vendor/swiper/swiper-bundle.min.css') }}" rel="stylesheet" />
    </noscript>

    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='img/favicon.ico') }}"
    />

    <!--Google Translate Scripts-->
    <script>
      function googleTranslateElementInit() {
        new google.translate.TranslateElement(
          {
            pageLanguage: "en",
          },
          "google_translate_element"
        );
      }
    </script>
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <!-- Preconnect to Google Fonts for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Load Google Fonts with display=swap for better performance -->
    <link 
      href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" 
      rel="stylesheet"
      media="print" 
      onload="this.media='all'"
    >
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    </noscript>

  <!-- EmailJS SDK v4 - CRITICAL CONFIGURATION:
       - Must be loaded ONLY ONCE in the entire application (here in layout.html)
       - Pinned to @4 to prevent breaking changes from major version updates
       - Using defer to ensure DOM is ready before initialization
       WARNING: Do not load EmailJS SDK in individual pages - it will cause conflicts -->
  <script defer src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  
  <!-- EmailJS Configuration - CRITICAL NOTES:
       - Configuration values are injected server-side from environment variables
       - PUBLIC_KEY comes from EMAILJS_API_ID environment variable (EmailJS account public key)
       - This configuration is shared across all pages via window.EMAILJS object
       WARNING: Individual pages must NOT re-configure these values -->
  <script>
    // Inject EmailJS configuration safely using tojson filter
    window.EMAILJS = {
      SERVICE_ID: {{ EMAILJS_SERVICE_ID | tojson | safe }},
      TEMPLATE_ID_CONFIRM: {{ EMAILJS_TEMPLATE_ID_FOR_PAYPAL_CONFIRMATION_EMAIL | tojson | safe }},
      PUBLIC_KEY: {{ EMAILJS_API_ID | tojson | safe }},  // From EMAILJS_API_ID env var - the account's public key
      RECIPIENT_EMAILS: {{ RECIPIENT_EMAILS | tojson | safe }}
    };
    
    // Expose local variable used elsewhere on the page
    var recipientEmails = window.EMAILJS.RECIPIENT_EMAILS || [];
    
    // Also expose the public key in a fallback variable for compatibility
    window.EMAILJS_PUBLIC_KEY = window.EMAILJS.PUBLIC_KEY;
  </script>
  
  <!-- Centralized EmailJS Initialization - ARCHITECTURE NOTES:
       - EmailJS MUST be initialized ONLY ONCE globally (handled here in layout.html)
       - The _emailjsInitialized flag prevents duplicate initialization attempts
       - Individual pages (contact.html, central_park_book.html, etc.) must NOT call emailjs.init()
       - Pages should only use emailjs.send() or emailjs.sendForm() after this global init
       WARNING: Re-initializing EmailJS in pages will break the email functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Wait for EmailJS SDK to be available
      if (!window.emailjs) {
        return;
      }
      
      // Use the existing config variable used by the working flows
      const PUBLIC_KEY = (window.EMAILJS && window.EMAILJS.PUBLIC_KEY) || window.EMAILJS_PUBLIC_KEY;
      
      if (!PUBLIC_KEY) {
        return;
      }
      
      // Initialize EmailJS only once globally - pages must not re-initialize
      if (!window._emailjsInitialized) {
        try {
          // EmailJS v4 preferred initialization format
          emailjs.init({ publicKey: PUBLIC_KEY });
          window._emailjsInitialized = true;
        } catch (e) {
          // Fallback for older init signature if needed
          try {
            emailjs.init(PUBLIC_KEY);
            window._emailjsInitialized = true;
          } catch (fallbackError) {
            // Silent failure
          }
        }
      }
    });
  </script>
  </head>

  <body>
    <!-- ======= Header ======= -->
    <header id="header">
      <div
        class="container-fluid container-xl d-flex align-items-center justify-content-lg-between"
      >
        <h1 class="logo me-auto me-lg-0">
          <a href="/">New York Archival Society</a>
        </h1>

        <nav id="navbar" class="navbar order-last order-lg-0">
          <ul>
            <li>
              <a class="nav-link scrollto active" href="/">Home</a>
            </li>
            <li>
              <a class="nav-link scrollto" href="{{ url_for('main.about') }}"
                >About</a
              >
            </li>
            <li class="dropdown">
              <a href="#"
                ><span>Support the Archives</span> <i class="bi bi-chevron-down"></i
              ></a>
              <ul>
                <li>
                  <a class="nav-link scrollto" href="/adopt-new-yorks-past"
                    >Adopt New York's Past</a
                  >
                </li>
                <li>
                  <a class="nav-link scrollto" href="/bonds"
                    >NYC Bonds</a
                  >
                </li>
                <li>
                  <a class="nav-link scrollto" href="/central-park-book"
                    >Central Park Book</a
                  >
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#"
                ><span>Projects</span> <i class="bi bi-chevron-down"></i
              ></a>
              <ul>
                <li>
                  <a
                    class="nav-link scrollto"
                    href="/koch-congressional-project"
                    >Edward I. Koch Congressional Project</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a
                class="nav-link scrollto"
                href="https://www.archives.nyc/blog"
                target="_blank"
                >Blog</a
              >
            </li>
            <li>
              <a class="nav-link scrollto" href="{{ url_for('main.events') }}"
                >Events</a
              >
            </li>
            <li>
              <a class="nav-link scrollto" href="{{ url_for('main.contact') }}"
                >Contact</a
              >
            </li>
            <li></li>
            <!-- Mobile-only Contribute link inside the collapsible nav -->
            <li class="d-lg-none">
              <a class="nav-link" href="{{ url_for('main.contribute') }}">Contribute</a>
            </li>
            <li class="dropdown">
              <a href="#"
                ><span>Translate</span><i class="bi bi-chevron-down"></i
              ></a>
              <ul id="translate-dropdown">
                <li>
                  <div id="google_translate_element"></div>
                </li>
              </ul>
            </li>
          </ul>
          <i class="bi bi-list mobile-nav-toggle"></i>
        </nav>
        <!-- .navbar -->
        
        <!-- Right-aligned CTA, visible on lg+ -->
        <a class="btn btn-contribute d-none d-lg-inline-flex ms-lg-3"
           href="{{ url_for('main.contribute') }}"
           aria-label="Contribute to the New York Archival Society">
          Contribute
        </a>
      </div>
    </header>
    <!-- End Header -->

    <main>
      {% block content %}
      <!-- This is where the content from child templates will be inserted -->
      {% endblock %}
    </main>
    <!-- ======= Footer ======= -->
    <footer class="mt-5" id="footer">
      <div class="footer-top">
        <div class="container">
          <div class="row">
            <div class="col-lg-3 col-md-6">
              <div class="footer-info">
                <h2>NEW YORK ARCHIVAL SOCIETY</h2>
                <div class="social-links mt-3">
                  <a
                    class="twitter"
                    href="http://www.twitter.com/nycrecords"
                    target="_blank"
                    aria-label="NYC Records Twitter"
                    ><i class="bx bxl-twitter"></i
                  ></a>
                  <a
                    class="facebook"
                    href="http://www.facebook.com/nycrecords"
                    target="_blank"
                    aria-label="NYC Records Facebook"
                    ><i class="bx bxl-facebook"></i
                  ></a>
                  <a
                    class="instagram"
                    href="https://www.instagram.com/nycarchives/"
                    target="_blank"
                    aria-label="NYC Archives Instagram"
                    ><i class="bx bxl-instagram"></i
                  ></a>
                  <a
                    class="youtube"
                    href="http://www.youtube.com/nycdeptofrecords"
                    target="_blank"
                    aria-label="NYC Records YouTube"
                    ><i class="bi bi-youtube"></i
                  ></a>
                </div>
              </div>
            </div>
            <div class="col-lg-2 col-md-6 footer-links">
              <ul>
                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="{{ url_for('main.index') }}">Home</a>
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="{{ url_for('main.about') }}">About Us</a>
                </li>

                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="{{ url_for('main.new_yorks_past') }}"
                    >Adopt New York's <br />Past</a
                  >
                </li>
                <li class="dropdown">
                  <i class="bx bx-chevron-right"></i>
                  <a href="#"><span>Our Projects</span> </a>
                  <ul>
                    <li>
                      <a
                        class="nav-link scrollto text-black"
                        href="/koch-congressional-project"
                        >Edward I. Koch Congressional Project</a
                      >
                    </li>
                    <!-- Other dropdown items here -->
                  </ul>
                </li>
              </ul>
            </div>
            <div class="col-lg-3 col-md-6 footer-links">
              <ul>
                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="{{ url_for('main.events') }}">Events</a>
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="https://www.archives.nyc/blog" target="_blank"
                    >Blog</a
                  >
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="{{ url_for('main.contact') }}">Contact</a>
                </li>
                <li>
                  <i class="bx bx-chevron-right"></i>
                  <a href="{{ url_for('main.contribute') }}">Contribute</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <!-- End Footer -->

    <!-- Libraries -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var dropdown = document.querySelector(".footer-links .dropdown");
        dropdown.addEventListener("click", function (event) {
          event.stopPropagation();
          dropdown.querySelector("ul").classList.toggle("show");
        });

        window.addEventListener("click", function () {
          var openDropdown = document.querySelector(
            ".footer-links .dropdown .show"
          );
          if (openDropdown) openDropdown.classList.remove("show");
        });
      });
    </script>

    <!-- Critical JavaScript - Load immediately -->
    <script
      defer
      src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"
    ></script>
    
    <!-- Custom lazy loading for images -->
    <script defer src="{{ url_for('static', filename='js/lazy-loading.js') }}"></script>

    <!-- Non-critical JavaScript - Load with lower priority -->
    <script
      defer
      src="{{ url_for('static', filename='vendor/aos/aos.js') }}"
      onload="AOS && AOS.init()"
    ></script>
    <script
      defer
      src="{{ url_for('static', filename='vendor/glightbox/js/glightbox.min.js') }}"
      onload="GLightbox && GLightbox()"
    ></script>
    <script
      defer
      src="{{ url_for('static', filename='vendor/isotope-layout/isotope.pkgd.min.js') }}"
    ></script>
    <script
      defer
      src="{{ url_for('static', filename='vendor/swiper/swiper-bundle.min.js') }}"
    ></script>

    <!-- Your Custom Script -->
    <script defer src="{{ url_for('static', filename='js/main.js') }}"></script>

    <!-- Ionicons Script - No change needed -->
    <script
      async
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
      type="module"
    ></script>

    <!--Google Translate Scripts and Links-->
    <script>
      ////////////////////////////////////////
      // Language, Search, and Menu Toggle
      ////////////////////////////////////////

      $("#global-language").on("show.bs.collapse", function () {
        $("#global-search").collapse("hide");
        $("#nav-primary").collapse("hide");
      });

      $("#global-search").on("show.bs.collapse", function () {
        $("#global-language").collapse("hide");
        $("#nav-primary").collapse("hide");
      });

      $("#nav-primary").on("show.bs.collapse", function () {
        $("#global-search").collapse("hide");
        $("#global-language").collapse("hide");
      });

      ////////////////////////////////////////
      // Language and Search Toggle Focus
      ////////////////////////////////////////

      $("#global-language")
        .on("shown.bs.collapse", function () {
          $(".goog-te-combo").focus();
        })
        .on("show.bs.collapse", function () {
          $(".goog-te-combo").blur();
        });

      $("#global-search")
        .on("shown.bs.collapse", function () {
          document.getElementById("global-search-bar").focus();
        })
        .on("show.bs.collapse", function () {
          document.getElementById("global-search-bar").blur();
        });

      ////////////////////////////////////////
      // Google Translate Links
      ////////////////////////////////////////

      $(".lang-select").click(function (e) {
        e.preventDefault();
        var lang = $(this).attr("data-lang");
        setLanguage(lang);
      });

      function setLanguage(theLang) {
        var theSelect = $(".goog-te-combo");
        var db = theSelect.get(0);
        theSelect.val(theLang);
        fireEvent(db, "change");
      }

      function fireEvent(element, event) {
        if (document.createEventObject) {
          var evt = document.createEventObject();
          return element.fireEvent("on" + event, evt);
        } else {
          var evt = document.createEvent("HTMLEvents");
          // event type, bubbling, cancelable
          evt.initEvent(event, false, true);
          return !element.dispatchEvent(evt);
        }
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const dropdowns = document.querySelectorAll(".navbar .dropdown > a");
        let openDropdownMenu = null;

        dropdowns.forEach(function (dropdown) {
          dropdown.addEventListener("click", function (event) {
            event.preventDefault();
            const dropdownMenu = this.nextElementSibling;

            if (dropdownMenu.style.display === "block") {
              dropdownMenu.style.display = "none";
              dropdownMenu.style.opacity = "0";
              dropdownMenu.style.visibility = "hidden";
              openDropdownMenu = null;
            } else {
              if (openDropdownMenu) {
                openDropdownMenu.style.display = "none";
                openDropdownMenu.style.opacity = "0";
                openDropdownMenu.style.visibility = "hidden";
              }
              dropdownMenu.style.display = "block";
              dropdownMenu.style.opacity = "1";
              dropdownMenu.style.visibility = "visible";
              openDropdownMenu = dropdownMenu;
            }
          });
        });

        document.addEventListener("click", function (event) {
          if (
            openDropdownMenu &&
            !openDropdownMenu.contains(event.target) &&
            !event.target.closest(".navbar .dropdown > a")
          ) {
            openDropdownMenu.style.display = "none";
            openDropdownMenu.style.opacity = "0";
            openDropdownMenu.style.visibility = "hidden";
            openDropdownMenu = null;
          }
        });
      });
    </script>

    <!--IspeakWidget Scripts-->
    <script>
      function translateclick(lang) {
        var translateElement = document.querySelector(".goog-te-combo");
        if (translateElement) {
          translateElement.value = lang;
          translateElement.dispatchEvent(new Event("change"));
        }
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const translateDropdown = document.querySelector(
          "#translate-dropdown > a"
        );

        if (translateDropdown) {
          translateDropdown.addEventListener("click", function (e) {
            e.preventDefault();
            const parent = this.parentElement;

            if (parent.classList.contains("active")) {
              parent.classList.remove("active");
            } else {
              document
                .querySelectorAll("#navbar .dropdown")
                .forEach((d) => d.classList.remove("active"));
              parent.classList.add("active");
            }
          });
        }
      });
    </script>
  </body>
</html>
